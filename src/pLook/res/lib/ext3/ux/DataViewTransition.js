/*
 * Ext JS Library 3.2.1
 * Copyright(c) 2006-2010 Ext JS, Inc.
 * licensing@extjs.com
 * http://www.extjs.com/license
 */
Ext.ux.DataViewTransition=Ext.extend(Object,{defaults:{duration:750,idProperty:"id"},constructor:function(a){Ext.apply(this,a||{},this.defaults)},init:function(a){this.dataview=a;var c=this.idProperty;a.blockRefresh=true;a.updateIndexes=a.updateIndexes.createSequence(function(){this.getTemplateTarget().select(this.itemSelector).each(function(e,f,d){e.id=e.dom.id=String.format("{0}-{1}",a.id,b.getAt(d).get(c))},this)},a);this.dataviewID=a.id;this.cachedStoreData={};var b=a.store;this.cacheStoreData(b);b.on("load",this.cacheStoreData,this);b.on("datachanged",function(m){var k=a.getTemplateTarget(),g=m.getAt(0),o=this.getAdded(m),w=this.getRemoved(m),h=this.getRemaining(m),t=Ext.apply({},h,o);Ext.each(w,function(B){Ext.fly(this.dataviewID+"-"+B.get(this.idProperty)).fadeOut({remove:false,duration:d/1000,useDisplay:true})},this);if(g==undefined){this.cacheStoreData(m);return}var f=k.child("#"+this.dataviewID+"-"+g.get(this.idProperty));var y=m.getCount(),j=f.getMargins("lr")+f.getWidth(),u=f.getMargins("bt")+f.getHeight(),q=k.getWidth(),e=Math.floor(q/j),p=Math.ceil(y/e),z=Math.ceil(this.getExistingCount()/e);k.applyStyles({display:"block",position:"relative"});var i={},A={},r={};Ext.iterate(h,function(D,C){var D=C.get(this.idProperty),B=r[D]=k.child("#"+this.dataviewID+"-"+D);i[D]={top:B.getTop()-k.getTop()-B.getMargins("t")-k.getPadding("t"),left:B.getLeft()-k.getLeft()-B.getMargins("l")-k.getPadding("l")}},this);Ext.iterate(h,function(E,D){var B=i[E],C=r[E];if(C.getStyle("position")!="absolute"){r[E].applyStyles({position:"absolute",left:B.left,top:B.top,width:C.getWidth(!Ext.isIE),height:C.getHeight(!Ext.isIE)})}});var n=0;Ext.iterate(m.data.items,function(D){var H=D.get(c),C=r[H];var B=n%e,G=Math.floor(n/e),F=G*u,E=B*j;A[H]={top:F,left:E};n++},this);var s=new Date(),d=this.duration,l=this.dataviewID;var x=function(){var K=new Date()-s,M=K/d;if(M>=1){for(var B in A){Ext.fly(l+"-"+B).applyStyles({top:A[B].top,left:A[B].left})}Ext.TaskMgr.stop(v)}else{for(var B in A){if(!h[B]){continue}var E=i[B],H=A[B],F=E.top,I=H.top,D=E.left,J=H.left,G=M*Math.abs(F-I),L=M*Math.abs(D-J),N=F>I?F-G:F+G,C=D>J?D-L:D+L;Ext.fly(l+"-"+B).applyStyles({top:N+"px",left:C+"px"})}}};var v={run:x,interval:20,scope:this};Ext.TaskMgr.start(v);Ext.iterate(o,function(C,B){Ext.fly(this.dataviewID+"-"+B.get(this.idProperty)).applyStyles({top:A[C].top,left:A[C].left}).fadeIn({remove:false,duration:d/1000})},this);this.cacheStoreData(m)},this)},cacheStoreData:function(a){this.cachedStoreData={};a.each(function(b){this.cachedStoreData[b.get(this.idProperty)]=b},this)},getExisting:function(){return this.cachedStoreData},getExistingCount:function(){var c=0,b=this.getExisting();for(var a in b){c++}return c},getAdded:function(a){var b={};a.each(function(c){if(this.cachedStoreData[c.get(this.idProperty)]==undefined){b[c.get(this.idProperty)]=c}},this);return b},getRemoved:function(a){var b=[];for(var c in this.cachedStoreData){if(a.findExact(this.idProperty,Number(c))==-1){b.push(this.cachedStoreData[c])}}return b},getRemaining:function(a){var b={};a.each(function(c){if(this.cachedStoreData[c.get(this.idProperty)]!=undefined){b[c.get(this.idProperty)]=c}},this);return b}});